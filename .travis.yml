language: cpp
dist: xenial
branches:
  only:
  - master
  - develop
  - feature/travis

matrix:
  fast_finish: true
  allow_failures:
    - stage: Code analysis and deployment
  include:
  - stage: Build and test
    name: Linux - GCC
    os: linux
    compiler: gcc
    before_install:
    - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - sudo apt-get update -qq
    install:
    - sudo apt-get install -y -qq g++-8
    - sudo apt-get install -y -qq --no-install-recommends make libx11-dev libxcursor-dev libxrandr-dev libxinerama-dev
    - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 90
    - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-8 90
    script:
    - make -j 2 CC=$CC CXX=$CXX
  - name: Linux - Clang
    os: linux
    compiler: clang
    before_install:
    - sudo apt-get update -qq
    install:
    - sudo apt-get install -y -qq --no-install-recommends make libx11-dev libxcursor-dev
      libxrandr-dev libxinerama-dev
    script:
    - make -j 2 CC=$CC CXX=$CXX
  - name: Windows - GCC
    os: windows
    compiler: gcc
    script:
    - mingw32-make -j 2 CC=$CC CXX=$CXX
  - name: Windows - MSVC
    os: windows
    env: MSBUILD_PATH="/C/Program Files (x86)/Microsoft Visual Studio/2017/BuildTools/MSBuild/15.0/Bin"
    script:
    - export PATH=$MSBUILD_PATH:$PATH
    - MSBuild.exe MeshEditor.sln -t:"Projects\MeshEditor" -p:configuration=release -p:platform=x64
  - stage: Code analysis and deployment
    name: SonarQube code analysis
    os: linux
    compiler: gcc
    cache:
      directories:
      - /home/travis/.sonar/cache
    addons:
      sonarcloud:
        organization: "harfangeek-github"
        token: $SONARCLOUD_TOKEN
    before_install:
    - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - sudo apt-get update -qq
    install:
    - sudo apt-get install -y -qq g++-8
    - sudo apt-get install -y -qq --no-install-recommends make libx11-dev libxcursor-dev libxrandr-dev libxinerama-dev
    - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 90
    - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-8 90
    script:
    - build-wrapper-linux-x86-64 --out-dir bw-output make
    - sonar-scanner


